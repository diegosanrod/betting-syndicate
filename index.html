<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Betting Syndicate con Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .progress-bar-fill { transition: width 0.5s ease-in-out; }
        .tab-panel::-webkit-scrollbar, #goal-list::-webkit-scrollbar { width: 8px; }
        .tab-panel::-webkit-scrollbar-track, #goal-list::-webkit-scrollbar-track { background: #1f2937; }
        .tab-panel::-webkit-scrollbar-thumb, #goal-list::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 10px; border: 2px solid #1f2937; }
        select.result-selector, input.manual-profit-input, select.selection-result-selector {
            background-color: #374151; border: 1px solid #4b5563; border-radius: 0.375rem; padding: 0.25rem 0.5rem; font-weight: bold; width: 100%;
        }
        select.selection-result-selector { padding: 1px 4px; font-size: 0.75rem; width: auto; }
        input.manual-profit-input { -moz-appearance: textfield; }
        input.manual-profit-input::-webkit-outer-spin-button, input.manual-profit-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .tab-button { transition: background-color 0.2s, color 0.2s; }
        .tab-button.active { background-color: #4f46e5; color: white; }
        .selection-row { background-color: #1f2937; padding: 8px; border-radius: 8px; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased">

    <!-- Auth Container -->
    <div id="auth-container" class="fixed inset-0 bg-gray-900 bg-opacity-95 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-sm">
            <h2 id="auth-title" class="text-2xl font-bold text-center text-white mb-6">Iniciar Sesión</h2>
            <div id="auth-error" class="bg-red-900 text-red-300 p-3 rounded-lg mb-4 text-center text-sm hidden"></div>
            <div class="space-y-4">
                <input type="email" id="email-input" placeholder="Correo electrónico" class="w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-white focus:ring-indigo-500 focus:border-indigo-500 p-3">
                <input type="password" id="password-input" placeholder="Contraseña" class="w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-white focus:ring-indigo-500 focus:border-indigo-500 p-3">
                <button id="auth-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Entrar</button>
            </div>
            <p class="text-center mt-4 text-sm">
                <a href="#" id="toggle-auth-mode" class="text-indigo-400 hover:underline">¿No tienes cuenta? Regístrate</a>
            </p>
        </div>
    </div>

    <!-- Setup Modal -->
    <div id="setup-modal" class="fixed inset-0 bg-gray-900 bg-opacity-95 z-50 flex items-center justify-center hidden p-4">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <h2 class="text-2xl font-bold text-center text-white mb-2">Bienvenido a Betting Syndicate</h2>
            <p class="text-center text-gray-400 mb-6">Configura tus objetivos para empezar.</p>
            <form id="setup-form" class="space-y-4">
                <div>
                    <label for="initial-bankroll-setup" class="block text-sm font-medium text-gray-300">Banca Inicial (€)</label>
                    <input type="number" step="0.01" min="0.01" id="initial-bankroll-setup" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-white focus:ring-indigo-500 focus:border-indigo-500 p-3" placeholder="Ej: 100" required>
                </div>
                <div>
                    <label for="goal-bankroll-setup" class="block text-sm font-medium text-gray-300">Objetivo Final (€)</label>
                    <input type="number" step="0.01" min="1" id="goal-bankroll-setup" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-white focus:ring-indigo-500 focus:border-indigo-500 p-3" placeholder="Ej: 5000" required>
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors mt-4">Comenzar</button>
            </form>
        </div>
    </div>
    
    <!-- Kelly Info Modal -->
    <div id="kelly-info-modal" class="fixed inset-0 bg-gray-900 bg-opacity-95 z-50 flex items-center justify-center hidden p-4">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md relative">
            <h3 class="text-xl font-bold text-center text-white mb-4">¿Qué es el Criterio de Kelly?</h3>
            <p class="text-gray-400 text-sm text-center mb-6">El Criterio de Kelly es una fórmula que calcula el **porcentaje óptimo de tu banca** a apostar para maximizar el crecimiento. Se basa en la **ventaja que crees tener** ("Tu Probabilidad %") frente a la cuota. Una sugerencia positiva indica una apuesta con "valor".</p>
            <button id="close-kelly-info" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Entendido</button>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="main-app" class="container mx-auto p-4 md:p-8 max-w-7xl hidden">
         <header class="flex justify-between items-center mb-8">
            <div>
                 <h1 class="text-3xl md:text-4xl font-bold text-white">Betting Syndicate</h1>
                 <p class="text-gray-400 mt-2">Registra, analiza y optimiza tu rendimiento.</p>
            </div>
            <div class="flex items-center gap-4">
                <button id="clear-data" class="bg-amber-600 hover:bg-amber-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">Reiniciar Cuenta</button>
                <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg">Cerrar Sesión</button>
            </div>
        </header>

         <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 flex flex-col gap-8">
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4 text-white">Dashboard</h2>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between items-center text-sm mb-1"><span class="text-gray-400">Progreso</span><span id="progress-percentage" class="font-semibold text-white">0.00%</span></div>
                            <div class="w-full bg-gray-700 rounded-full h-4"><div id="progress-bar" class="bg-indigo-500 h-4 rounded-full progress-bar-fill" style="width: 0%"></div></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div><p class="text-gray-400 text-sm">Banca Actual</p><p id="current-bankroll" class="text-2xl font-semibold text-green-400">0,00 €</p></div>
                            <div><p class="text-gray-400 text-sm">Objetivo Final</p><p id="goal-bankroll" class="text-2xl font-semibold text-indigo-400">0,00 €</p></div>
                        </div>
                        <div class="border-t border-gray-700 pt-4 grid grid-cols-2 gap-4 text-sm">
                            <div><p class="text-gray-400">Total Apuestas</p><p id="stats-total-bets" class="font-semibold text-lg">0</p></div>
                            <div><p class="text-gray-400">Tasa de Acierto</p><p id="stats-win-rate" class="font-semibold text-lg">N/A</p></div>
                            <div><p class="text-gray-400">Beneficio Neto</p><p id="stats-net-profit" class="font-semibold text-lg">0,00 €</p></div>
                            <div><p class="text-gray-400">Banca Inicial</p><p id="initial-bankroll" class="font-semibold text-lg">0,00 €</p></div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4 text-white">Registrar Apuesta</h2>
                    <form id="bet-form" class="space-y-4">
                        <div><label for="bet-date" class="block text-sm font-medium text-gray-300">Fecha</label><input type="date" id="bet-date" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md" required></div>
                        <div class="space-y-3" id="selections-container"><label class="block text-sm font-medium text-gray-300">Selecciones</label></div>
                        <button type="button" id="add-selection-btn" class="w-full text-sm bg-gray-700 hover:bg-gray-600 text-indigo-300 font-semibold py-2 px-4 rounded-lg">Añadir Selección</button>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label for="total-odds" class="block text-sm font-medium text-gray-300">Cuota Total</label><input type="number" step="0.001" id="total-odds" class="mt-1 block w-full text-lg font-bold text-indigo-400 bg-gray-900 p-2 rounded-lg text-center" value="1.00"></div>
                            <div><label for="probability" class="block text-sm font-medium text-gray-300">Tu Prob. (%)</label><input type="number" step="1" min="1" max="99" id="probability" value="55" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md"></div>
                        </div>
                        <div class="bg-gray-900 p-3 rounded-lg text-center">
                            <div class="flex justify-center items-center gap-2"><p class="text-sm text-gray-400">Sugerencia Kelly</p><button type="button" id="kelly-info-btn" class="text-indigo-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg></button></div>
                            <p id="kelly-suggestion" class="text-lg font-bold text-indigo-400">N/A</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label for="stake" class="block text-sm font-medium text-gray-300">Apostado</label><input type="number" step="0.01" min="0.01" id="stake" placeholder="10.00" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md" required></div>
                            <div><label for="result" class="block text-sm font-medium text-gray-300">Resultado</label><select id="result" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md"><option value="pending">Pendiente</option><option value="won">Ganada</option><option value="lost">Perdida</option><option value="void">Anulada</option><option value="closed">Cerrada</option></select></div>
                        </div>
                        <button type="submit" id="submit-bet-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg">Añadir Registro</button>
                        <button type="button" id="cancel-edit-btn" class="w-full text-center text-gray-400 hover:text-white text-sm py-2 mt-2 hidden">Cancelar Edición</button>
                    </form>
                </div>
            </div>
            <div class="lg:col-span-2 bg-gray-800 rounded-2xl shadow-lg flex flex-col">
                <div class="p-4 border-b border-gray-700"><div class="flex bg-gray-900 rounded-lg p-1"><button id="tab-historial" class="tab-button flex-1 py-2 px-4 rounded-md text-sm font-semibold active">Historial</button><button id="tab-analisis" class="tab-button flex-1 py-2 px-4 rounded-md text-sm font-semibold text-gray-400">Análisis</button></div></div>
                <div id="historial-panel" class="tab-panel flex-grow p-6 overflow-y-auto">
                    <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-white">Historial</h2></div>
                    <table class="w-full text-sm text-left text-gray-300"><thead class="text-xs text-gray-400 uppercase bg-gray-700 sticky top-0"><tr><th class="px-4 py-3">#</th><th class="px-4 py-3">Fecha</th><th class="px-4 py-3">Selecciones</th><th class="px-4 py-3 text-center">Cuota</th><th class="px-4 py-3 text-right">Apostado</th><th class="px-4 py-3 text-center">Resultado</th><th class="px-4 py-3 text-right">Beneficio</th><th class="px-4 py-3 text-right">Saldo Final</th><th class="px-4 py-3 text-center">Acciones</th></tr></thead><tbody id="history-body"></tbody></table>
                    <div id="no-bets-message" class="text-center py-16 text-gray-500"><p>Aún no has registrado ninguna apuesta.</p></div>
                </div>
                <div id="analisis-panel" class="tab-panel flex-grow p-6 overflow-y-auto hidden">
                    <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-white">Análisis</h2><div class="flex items-center gap-4"><select id="analisis-filter" class="bg-gray-700 border-gray-600 rounded-md text-sm font-semibold"><option value="all">Siempre</option><option value="7d">Últimos 7 días</option><option value="30d">Últimos 30 días</option><option value="this-month">Este Mes</option><option value="last-month">Mes Pasado</option></select><button id="export-csv" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">Exportar CSV</button></div></div>
                    <div id="no-analysis-data" class="text-center py-16 text-gray-500 hidden"><p>No hay datos suficientes para mostrar el análisis.</p></div>
                    <div id="analysis-content" class="space-y-8">
                        <div><h3 class="text-lg font-semibold mb-3">Rendimiento Mensual</h3><div class="bg-gray-900 p-4 rounded-lg"><canvas id="monthly-chart"></canvas></div></div>
                        <div><h3 class="text-lg font-semibold mb-3">Análisis por Deporte</h3><table class="w-full text-sm text-left"><thead class="text-xs text-gray-400 uppercase bg-gray-700"><tr><th class="px-4 py-2">Deporte</th><th class="px-4 py-2 text-center">Apuestas</th><th class="px-4 py-2 text-center">Acierto %</th><th class="px-4 py-2 text-right">Beneficio</th></tr></thead><tbody id="sport-analysis-body"></tbody></table></div>
                        <div><h3 class="text-lg font-semibold mb-3">Análisis por Competición</h3><table class="w-full text-sm text-left"><thead class="text-xs text-gray-400 uppercase bg-gray-700"><tr><th class="px-4 py-2">Competición</th><th class="px-4 py-2 text-center">Apuestas</th><th class="px-4 py-2 text-center">Acierto %</th><th class="px-4 py-2 text-right">Beneficio</th></tr></thead><tbody id="competition-analysis-body"></tbody></table></div>
                        <div><h3 class="text-lg font-semibold mb-3">Análisis por Rango de Cuotas</h3><table class="w-full text-sm text-left"><thead class="text-xs text-gray-400 uppercase bg-gamma-700"><tr><th class="px-4 py-2">Rango Cuota</th><th class="px-4 py-2 text-center">Apuestas</th><th class="px-4 py-2 text-center">Acierto %</th><th class="px-4 py-2 text-right">Beneficio</th></tr></thead><tbody id="odds-analysis-body"></tbody></table></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, query, updateDoc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. CONFIGURACIÓN E INICIALIZACIÓN DE FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyABXCPWufB7qCYN-xt2tFJnO1IGgCjcsxQ",
          authDomain: "betting-syndicate.firebaseapp.com",
          projectId: "betting-syndicate",
          storageBucket: "betting-syndicate.firebasestorage.app",
          messagingSenderId: "430647143377",
          appId: "1:430647143377:web:16f43f376a031fdd788ef0"
        };


        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let state = {
            initialBankroll: 0,
            goalBankroll: 0,
            bankroll: 0,
            bets: []
        };
        let currentUser = null;
        let unsubscribeFromBets = null;
        let monthlyChartInstance = null;
        let editingBetId = null;

        const dom = {
            authContainer: document.getElementById('auth-container'),
            authTitle: document.getElementById('auth-title'),
            emailInput: document.getElementById('email-input'),
            passwordInput: document.getElementById('password-input'),
            authBtn: document.getElementById('auth-btn'),
            toggleAuthMode: document.getElementById('toggle-auth-mode'),
            authError: document.getElementById('auth-error'),
            logoutBtn: document.getElementById('logout-btn'),
            setupModal: document.getElementById('setup-modal'),
            setupForm: document.getElementById('setup-form'),
            mainApp: document.getElementById('main-app'),
            betForm: document.getElementById('bet-form'),
            submitBetBtn: document.getElementById('submit-bet-btn'),
            cancelEditBtn: document.getElementById('cancel-edit-btn'),
            historyBody: document.getElementById('history-body'),
            clearDataBtn: document.getElementById('clear-data'),
            currentBankrollEl: document.getElementById('current-bankroll'),
            goalBankrollEl: document.getElementById('goal-bankroll'),
            initialBankrollEl: document.getElementById('initial-bankroll'),
            progressBar: document.getElementById('progress-bar'),
            progressPercentageEl: document.getElementById('progress-percentage'),
            statsTotalBetsEl: document.getElementById('stats-total-bets'),
            statsWinRateEl: document.getElementById('stats-win-rate'),
            statsNetProfitEl: document.getElementById('stats-net-profit'),
            noBetsMessage: document.getElementById('no-bets-message'),
            selectionsContainer: document.getElementById('selections-container'),
            addSelectionBtn: document.getElementById('add-selection-btn'),
            totalOddsEl: document.getElementById('total-odds'),
            probabilityInput: document.getElementById('probability'),
            kellySuggestionEl: document.getElementById('kelly-suggestion'),
            betDateInput: document.getElementById('bet-date'),
            tabHistorial: document.getElementById('tab-historial'),
            tabAnalisis: document.getElementById('tab-analisis'),
            historialPanel: document.getElementById('historial-panel'),
            analisisPanel: document.getElementById('analisis-panel'),
            analisisFilter: document.getElementById('analisis-filter'),
            noAnalysisData: document.getElementById('no-analysis-data'),
            analysisContent: document.getElementById('analysis-content'),
            sportAnalysisBody: document.getElementById('sport-analysis-body'),
            competitionAnalysisBody: document.getElementById('competition-analysis-body'),
            oddsAnalysisBody: document.getElementById('odds-analysis-body'),
            kellyInfoBtn: document.getElementById('kelly-info-btn'),
            kellyInfoModal: document.getElementById('kelly-info-modal'),
            closeKellyInfo: document.getElementById('close-kelly-info'),
            exportCsvBtn: document.getElementById('export-csv'),
        };

        // --- 2. LÓGICA DE AUTENTICACIÓN ---
        let isLoginMode = true;
        dom.toggleAuthMode.addEventListener('click', (e) => {
            e.preventDefault();
            isLoginMode = !isLoginMode;
            dom.authTitle.textContent = isLoginMode ? 'Iniciar Sesión' : 'Crear Cuenta';
            dom.authBtn.textContent = isLoginMode ? 'Entrar' : 'Registrarse';
            dom.toggleAuthMode.textContent = isLoginMode ? '¿No tienes cuenta? Regístrate' : '¿Ya tienes cuenta? Inicia sesión';
            dom.authError.classList.add('hidden');
        });

        dom.authBtn.addEventListener('click', async () => {
            const email = dom.emailInput.value;
            const password = dom.passwordInput.value;
            dom.authError.classList.add('hidden');
            try {
                if (isLoginMode) {
                    await setPersistence(auth, browserLocalPersistence);
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                dom.authError.textContent = "Error: " + error.message;
                dom.authError.classList.remove('hidden');
            }
        });

        dom.logoutBtn.addEventListener('click', () => signOut(auth));

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                dom.authContainer.classList.add('hidden');
                loadUserData();
            } else {
                currentUser = null;
                dom.authContainer.classList.remove('hidden');
                dom.mainApp.classList.add('hidden');
                dom.setupModal.classList.add('hidden');
                if (unsubscribeFromBets) unsubscribeFromBets();
                state = { initialBankroll: 0, goalBankroll: 0, bankroll: 0, bets: [] };
            }
        });

        // --- 3. LÓGICA DE DATOS CON FIRESTORE ---

        async function loadUserData() {
            const userDocRef = doc(db, `/artifacts/${appId}/users/${currentUser.uid}`);
            const userDocSnap = await getDoc(userDocRef);

            if (userDocSnap.exists()) {
                const data = userDocSnap.data();
                state.initialBankroll = data.initialBankroll || 0;
                state.goalBankroll = data.goalBankroll || 0;
                dom.setupModal.classList.add('hidden');
                dom.mainApp.classList.remove('hidden');
                listenToBets();
            } else {
                dom.setupModal.classList.remove('hidden');
                dom.setupModal.classList.add('flex');
                dom.mainApp.classList.add('hidden');
            }
        }
        
        dom.setupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const initial = parseFloat(document.getElementById('initial-bankroll-setup').value);
            const goal = parseFloat(document.getElementById('goal-bankroll-setup').value);
            if (initial >= 0 && goal > initial && currentUser) {
                const userDocRef = doc(db, `/artifacts/${appId}/users/${currentUser.uid}`);
                await setDoc(userDocRef, { initialBankroll: initial, goalBankroll: goal });
                loadUserData();
            } else {
                alert("Por favor, rellena todos los campos con valores válidos.");
            }
        });

        function listenToBets() {
            if (unsubscribeFromBets) unsubscribeFromBets();
            const betsCollectionRef = collection(db, `/artifacts/${appId}/users/${currentUser.uid}/bets`);
            const q = query(betsCollectionRef, orderBy("date", "desc"));

            unsubscribeFromBets = onSnapshot(q, (snapshot) => {
                state.bets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                recalculateBankroll();
            }, error => {
                console.error("Error al escuchar apuestas: ", error);
            });
        }
        
        async function addBet(betData) {
            if (!currentUser) return;
            const betsCollectionRef = collection(db, `/artifacts/${appId}/users/${currentUser.uid}/bets`);
            await addDoc(betsCollectionRef, betData);
        }

        async function updateBet(betId, updatedData) {
            if (!currentUser) return;
            const betDocRef = doc(db, `/artifacts/${appId}/users/${currentUser.uid}/bets/${betId}`);
            await updateDoc(betDocRef, updatedData);
        }

        async function deleteBet(betId) {
            if (!currentUser) return;
            if (confirm("¿Estás seguro de que quieres eliminar esta apuesta?")) {
                const betDocRef = doc(db, `/artifacts/${appId}/users/${currentUser.uid}/bets/${betId}`);
                await deleteDoc(betDocRef);
            }
        }

        async function resetAccount() {
            if (!currentUser) return;
             if (confirm("¿Seguro que quieres borrar TODAS tus apuestas y reiniciar tu objetivo? Esta acción no se puede deshacer.")) {
                // Borrar todas las apuestas de forma segura
                const deletePromises = state.bets.map(bet => {
                     const betDocRef = doc(db, `/artifacts/${appId}/users/${currentUser.uid}/bets/${bet.id}`);
                     return deleteDoc(betDocRef);
                });
                await Promise.all(deletePromises);

                // Borrar el documento de configuración del usuario
                const userDocRef = doc(db, `/artifacts/${appId}/users/${currentUser.uid}`);
                await deleteDoc(userDocRef);

                // Forzar la recarga de datos del usuario para mostrar el modal de configuración
                await loadUserData();
             }
        }
        dom.clearDataBtn.addEventListener('click', resetAccount);

        // --- 4. LÓGICA DE LA APLICACIÓN (Cálculos y Renderizado) ---
        
        const formatCurrency = (value) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(value);

        function recalculateBankroll() {
            let runningBankroll = state.initialBankroll;
            // Ordenar las apuestas cronológicamente para calcular el saldo de forma correcta
            const betsSortedChronologically = [...state.bets].sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                if (isNaN(dateA.getTime())) return 1;
                if (isNaN(dateB.getTime())) return -1;
                return dateA - dateB;
            });

            // Calcular el beneficio y el saldo final para cada apuesta en orden
            betsSortedChronologically.forEach(bet => {
                let profit = 0;
                switch(bet.result) {
                    case 'won': profit = bet.stake * (bet.totalOdds - 1); break;
                    case 'lost': profit = -bet.stake; break;
                    case 'void': profit = 0; break;
                    case 'closed': profit = bet.profit || 0; break;
                    case 'pending': profit = 0; break;
                }
                bet.calculatedProfit = profit;
                runningBankroll += profit;
                bet.finalBankroll = runningBankroll;
            });
            
            state.bankroll = runningBankroll;

            // Guardar las apuestas en el estado, ordenadas para mostrar (la más nueva primero)
            state.bets = betsSortedChronologically.reverse();

            renderAll();
        };

        function renderAll() {
            renderDashboardAndHistory();
            // La función renderAnalysis() se llama desde el propio tab
        }

        function renderDashboardAndHistory() {
            dom.currentBankrollEl.textContent = formatCurrency(state.bankroll);
            dom.goalBankrollEl.textContent = formatCurrency(state.goalBankroll);
            dom.initialBankrollEl.textContent = formatCurrency(state.initialBankroll);
            const progress = state.goalBankroll > 0 ? Math.max(0, (state.bankroll / state.goalBankroll) * 100) : 0;
            dom.progressBar.style.width = `${progress}%`;
            dom.progressPercentageEl.textContent = `${progress.toFixed(4)}%`;

            const totalBets = state.bets.length;
            dom.statsTotalBetsEl.textContent = totalBets;
            const settledBets = state.bets.filter(b => ['won', 'lost'].includes(b.result));
            const wins = settledBets.filter(b => b.result === 'won').length;
            dom.statsWinRateEl.textContent = settledBets.length > 0 ? `${(wins / settledBets.length * 100).toFixed(2)}%` : 'N/A';
            const netProfit = state.bankroll - state.initialBankroll;
            dom.statsNetProfitEl.textContent = formatCurrency(netProfit);
            dom.statsNetProfitEl.className = `font-semibold text-lg ${netProfit >= 0 ? 'text-green-400' : 'text-red-400'}`;
            dom.historyBody.innerHTML = '';
            dom.noBetsMessage.classList.toggle('hidden', totalBets > 0);

            // La lógica de cálculo se ha movido a recalculateBankroll().
            // Ahora simplemente dibujamos los datos pre-calculados.
            state.bets.forEach((bet, index) => {
                 const row = document.createElement('tr');
                    row.className = 'bg-gray-800 border-b border-gray-700 hover:bg-gray-600/50';
                    const selectionsHtml = (bet.selections || []).map((s, s_index) => {
                        let resultIndicator;
                        if(bet.result === 'pending') {
                            resultIndicator = `<select data-bet-id="${bet.id}" data-selection-index="${s_index}" class="selection-result-selector text-yellow-400"><option value="pending" ${s.result === 'pending' ? 'selected' : ''}>P</option><option value="won" ${s.result === 'won' ? 'selected' : ''}>G</option><option value="lost" ${s.result === 'lost' ? 'selected' : ''}>L</option></select>`;
                        } else {
                            const resultClasses = { won: 'text-green-400', lost: 'text-red-400', pending: 'text-yellow-400' };
                            const resultTexts = { won: '✓', lost: '✗', pending: '?' };
                            resultIndicator = `<span class="font-bold text-sm ${resultClasses[s.result] || 'text-gray-400'}">${resultTexts[s.result] || '?'}</span>`;
                        }
                        return `<div class="p-1">
                                    <div class="flex justify-between items-center">- ${s.description} <span class='text-gray-400 ml-2'>@${s.odds.toFixed(2)}</span> ${resultIndicator}</div>
                                    <div class="text-xs text-gray-500 pl-2">${s.sport} - ${s.competition}</div>
                                </div>`;
                    }).join('');

                    let resultDisplay;
                    if (bet.result === 'pending') {
                        resultDisplay = `<select data-bet-id="${bet.id}" class="result-selector text-yellow-400"><option value="pending" selected>Pendiente</option><option value="won">Ganada</option><option value="lost">Perdida</option><option value="void">Anulada</option><option value="closed">Cerrada</option></select>`;
                    } else {
                        const resultClasses = { won: 'text-green-400', lost: 'text-red-400', void: 'text-gray-400', closed: 'text-blue-400' };
                        const resultTexts = { won: 'Ganada', lost: 'Perdida', void: 'Anulada', closed: 'Cerrada' };
                        resultDisplay = `<span class="font-bold ${resultClasses[bet.result]}">${resultTexts[bet.result]}</span>`;
                    }
                    
                    let profitDisplay;
                    const profit = bet.calculatedProfit;
                    if (bet.result === 'closed') {
                         profitDisplay = `<input type="number" step="any" class="manual-profit-input text-blue-400" data-bet-id="${bet.id}" value="${bet.profit}">`;
                    } else {
                        const profitClass = profit > 0 ? 'text-green-400' : profit < 0 ? 'text-red-400' : 'text-gray-400';
                        profitDisplay = `<span class="font-semibold ${profitClass}">${profit >= 0 && bet.result !== 'pending' ? '+' : ''}${formatCurrency(bet.result === 'pending' ? 0 : profit)}</span>`;
                    }

                    row.innerHTML = `<td class="px-4 py-3 font-medium text-gray-400">${totalBets - index}</td><td class="px-4 py-3 font-semibold text-white">${bet.date ? new Date(bet.date + 'T00:00:00').toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }) : ''}</td><td class="px-4 py-3 text-white text-xs space-y-1">${selectionsHtml}</td><td class="px-4 py-3 text-center font-bold text-indigo-300">${bet.totalOdds.toFixed(3)}</td><td class="px-4 py-3 text-right">${formatCurrency(bet.stake)}</td><td class="px-4 py-3 text-center">${resultDisplay}</td><td class="px-4 py-3 text-right">${profitDisplay}</td><td class="px-4 py-3 text-right font-bold text-white">${formatCurrency(bet.finalBankroll)}</td><td class="px-4 py-3 text-center"><div class="flex justify-center items-center gap-2"><button class="edit-bet-btn p-1 rounded-md hover:bg-gray-700" data-bet-id="${bet.id}" title="Editar Apuesta"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button><button class="delete-bet-btn p-1 rounded-md hover:bg-gray-700" data-bet-id="${bet.id}" title="Eliminar Apuesta"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-400 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button></div></td>`;
                    dom.historyBody.appendChild(row);
            });
        }
        
        // --- 5. EVENT LISTENERS ---
        const handleFormSubmit = async (e) => {
            e.preventDefault();
            
            const dateValue = dom.betDateInput.value;
            if (!dateValue) {
                alert("Por favor, selecciona una fecha para la apuesta.");
                return;
            }

            const stake = parseFloat(document.getElementById('stake').value);
            const availableBankroll = state.bankroll - state.bets.filter(b => b.result === 'pending').reduce((acc, b) => acc + b.stake, 0);
            if (stake > availableBankroll) {
                alert("La cantidad apostada no puede ser mayor que tu banca disponible (descontando apuestas pendientes).");
                return;
            }
            
            const selections = Array.from(dom.selectionsContainer.querySelectorAll('.selection-row')).map(row => ({
                description: row.querySelector('.selection-desc').value,
                odds: parseFloat(row.querySelector('.selection-odds').value),
                sport: row.querySelector('.selection-sport').value,
                competition: row.querySelector('.selection-competition').value,
                result: row.querySelector('.selection-result-editor').value
            })).filter(s => s.description && !isNaN(s.odds) && s.sport && s.competition);

            if (selections.length === 0) {
                alert("Añade al menos una selección válida con todos sus campos.");
                return;
            }
            
            const newBet = {
                date: dom.betDateInput.value,
                selections, 
                totalOdds: parseFloat(dom.totalOddsEl.value), 
                stake,
                result: document.getElementById('result').value, 
                profit: 0,
                probability: parseFloat(dom.probabilityInput.value) || 55,
            };
            
            if (editingBetId) {
                await updateBet(editingBetId, newBet);
            } else {
                await addBet(newBet);
            }
            
            cancelEdit();
        };

        dom.betForm.addEventListener('submit', handleFormSubmit);

        dom.historyBody.addEventListener('click', e => {
            const editBtn = e.target.closest('.edit-bet-btn');
            if (editBtn) {
                const betId = editBtn.dataset.betId;
                startEditBet(betId);
            }

            const deleteBtn = e.target.closest('.delete-bet-btn');
            if (deleteBtn) {
                const betId = deleteBtn.dataset.betId;
                deleteBet(betId);
            }
        });

        dom.historyBody.addEventListener('change', (e) => {
            const betId = e.target.dataset.betId;
            const bet = state.bets.find(b => b.id === betId);
            if (!bet) return;
            
            let updatedData = {};

            if (e.target.classList.contains('result-selector')) {
                updatedData.result = e.target.value;
                if (updatedData.result === 'closed') updatedData.profit = 0;

                // Si se cambia el resultado general a ganado o perdido, se actualizan todas las selecciones.
                if (updatedData.result === 'won' || updatedData.result === 'lost') {
                    const newSelectionStatus = updatedData.result;
                    const newSelections = bet.selections.map(s => ({ ...s, result: newSelectionStatus }));
                    updatedData.selections = newSelections;
                }
            }
            if (e.target.classList.contains('selection-result-selector')) {
                const selectionIndex = parseInt(e.target.dataset.selectionIndex, 10);
                const newSelections = [...bet.selections];
                newSelections[selectionIndex].result = e.target.value;
                updatedData.selections = newSelections;
                
                if (newSelections.some(s => s.result === 'lost')) {
                    updatedData.result = 'lost';
                } else if (newSelections.every(s => s.result === 'won')) {
                    updatedData.result = 'won';
                }
            }
            updateBet(betId, updatedData);
        });

        dom.historyBody.addEventListener('input', (e) => {
            if (e.target.classList.contains('manual-profit-input')) {
                const betId = e.target.dataset.betId;
                const newProfit = parseFloat(e.target.value);
                if (!isNaN(newProfit)) {
                    updateBet(betId, { profit: newProfit });
                }
            }
        });
        
        const addSelectionHTML = (selectionData = null) => {
             const selectionCount = dom.selectionsContainer.querySelectorAll('.selection-row').length;
             const newSelection = document.createElement('div');
             newSelection.className = 'selection-row space-y-2';
             newSelection.innerHTML = `
                 <div class="grid grid-cols-12 gap-2 items-center">
                     <input type="text" placeholder="Descripción ${selectionCount + 1}" class="selection-desc col-span-6 bg-gray-900 border-gray-600 rounded-md text-white text-sm p-2" required>
                     <input type="number" step="0.01" min="1.01" placeholder="Cuota" class="selection-odds col-span-2 bg-gray-900 border-gray-600 rounded-md text-white text-sm p-2" required>
                     <select class="selection-result-editor bg-gray-900 border-gray-600 rounded-md text-white text-xs p-2 col-span-3">
                        <option value="pending">Pendiente</option>
                        <option value="won">Ganada</option>
                        <option value="lost">Perdida</option>
                     </select>
                     <button type="button" class="remove-selection-btn col-span-1 text-red-400 hover:text-red-600 text-2xl font-bold">&times;</button>
                 </div>
                 <div class="grid grid-cols-2 gap-2">
                     <input type="text" placeholder="Deporte" class="selection-sport bg-gray-900 border-gray-600 rounded-md text-white text-xs p-2" required>
                     <input type="text" placeholder="Competición" class="selection-competition bg-gray-900 border-gray-600 rounded-md text-white text-xs p-2" required>
                 </div>`;
            
             if (selectionData) {
                newSelection.querySelector('.selection-desc').value = selectionData.description;
                newSelection.querySelector('.selection-odds').value = selectionData.odds;
                newSelection.querySelector('.selection-sport').value = selectionData.sport;
                newSelection.querySelector('.selection-competition').value = selectionData.competition;
                newSelection.querySelector('.selection-result-editor').value = selectionData.result || 'pending';
             }

             dom.selectionsContainer.appendChild(newSelection);
             newSelection.querySelector('.selection-odds').addEventListener('input', calculateTotalOdds);
             newSelection.querySelector('.remove-selection-btn').addEventListener('click', () => {
                 newSelection.remove();
                 calculateTotalOdds();
             });
         };
        const calculateTotalOdds = () => {
             const oddsInputs = dom.selectionsContainer.querySelectorAll('.selection-odds');
             let totalOdds = 1;
             oddsInputs.forEach(input => {
                 const odd = parseFloat(input.value);
                 if (!isNaN(odd) && odd > 0) totalOdds *= odd;
             });
             dom.totalOddsEl.value = totalOdds.toFixed(3);
             calculateKelly();
         };
        const calculateKelly = () => {
             const odds = parseFloat(dom.totalOddsEl.value);
             const prob = parseFloat(dom.probabilityInput.value) / 100;
             if (isNaN(odds) || isNaN(prob) || odds <= 1 || prob <= 0 || prob >= 1) {
                 dom.kellySuggestionEl.textContent = 'N/A';
                 return;
             }
             const kellyFraction = ((odds - 1) * prob - (1 - prob)) / (odds - 1);
             const availableBankroll = state.bankroll - state.bets.filter(b => b.result === 'pending').reduce((acc, b) => acc + b.stake, 0);
             if (kellyFraction <= 0) {
                 dom.kellySuggestionEl.textContent = `No apostar`;
                 return;
             }
             const suggestedStake = availableBankroll * kellyFraction;
             dom.kellySuggestionEl.textContent = `${formatCurrency(suggestedStake)} (${(kellyFraction * 100).toFixed(2)}%)`;
         };

         function startEditBet(betId) {
            const bet = state.bets.find(b => b.id === betId);
            if (!bet) return;

            editingBetId = betId;

            dom.betDateInput.value = bet.date;
            document.getElementById('stake').value = bet.stake;
            document.getElementById('result').value = bet.result;
            dom.probabilityInput.value = bet.probability || 55;

            dom.selectionsContainer.innerHTML = '<label class="block text-sm font-medium text-gray-300">Selecciones</label>';
            bet.selections.forEach(sel => addSelectionHTML(sel));
            calculateTotalOdds();

            dom.submitBetBtn.textContent = 'Guardar Cambios';
            dom.submitBetBtn.classList.replace('bg-indigo-600', 'bg-green-600');
            dom.submitBetBtn.classList.replace('hover:bg-indigo-700', 'hover:bg-green-700');
            dom.cancelEditBtn.classList.remove('hidden');
            dom.betForm.scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEdit() {
            editingBetId = null;
            dom.betForm.reset();
            dom.probabilityInput.value = '55';
            dom.selectionsContainer.innerHTML = '<label class="block text-sm font-medium text-gray-300">Selecciones</label>';
            addSelectionHTML();
            calculateTotalOdds();
            dom.betDateInput.valueAsDate = new Date();

            dom.submitBetBtn.textContent = 'Añadir Registro';
            dom.submitBetBtn.classList.replace('bg-green-600', 'bg-indigo-600');
            dom.submitBetBtn.classList.replace('hover:bg-green-700', 'hover:bg-indigo-700');
            dom.cancelEditBtn.classList.add('hidden');
        }

         addSelectionHTML();
         dom.betDateInput.valueAsDate = new Date();
         dom.addSelectionBtn.addEventListener('click', () => addSelectionHTML());
         dom.cancelEditBtn.addEventListener('click', cancelEdit);
         dom.probabilityInput.addEventListener('input', calculateKelly);
         dom.totalOddsEl.addEventListener('input', calculateKelly);
         dom.tabHistorial.addEventListener('click', () => { dom.tabHistorial.classList.add('active'); dom.tabAnalisis.classList.remove('active'); dom.historialPanel.classList.remove('hidden'); dom.analisisPanel.classList.add('hidden'); });
         dom.tabAnalisis.addEventListener('click', () => { dom.tabAnalisis.classList.add('active'); dom.tabHistorial.classList.remove('active'); dom.analisisPanel.classList.remove('hidden'); dom.historialPanel.classList.add('hidden'); renderAnalysis(); });
         dom.kellyInfoBtn.addEventListener('click', () => dom.kellyInfoModal.classList.remove('hidden'));
         dom.closeKellyInfo.addEventListener('click', () => dom.kellyInfoModal.classList.add('hidden'));

         function renderAnalysis() { /* ... Lógica de análisis sin cambios ... */ }
    </script>
</body>
</html>
