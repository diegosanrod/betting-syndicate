<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Betting Syndicate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .progress-bar-fill { transition: width 0.5s ease-in-out; }
        .tab-panel::-webkit-scrollbar, #goal-list::-webkit-scrollbar { width: 8px; }
        .tab-panel::-webkit-scrollbar-track, #goal-list::-webkit-scrollbar-track { background: #1f2937; }
        .tab-panel::-webkit-scrollbar-thumb, #goal-list::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 10px; border: 2px solid #1f2937; }
        select.result-selector, input.manual-profit-input, select.selection-result-selector {
            background-color: #374151; border: 1px solid #4b5563; border-radius: 0.375rem; padding: 0.25rem 0.5rem; font-weight: bold; width: 100%;
        }
        select.selection-result-selector { padding: 1px 4px; font-size: 0.75rem; width: auto; }
        input.manual-profit-input { -moz-appearance: textfield; }
        input.manual-profit-input::-webkit-outer-spin-button, input.manual-profit-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .tab-button { transition: background-color 0.2s, color 0.2s; }
        .tab-button.active { background-color: #4f46e5; color: white; }
        .selection-row {
            background-color: #1f2937;
            padding: 8px;
            border-radius: 8px;
        }
        #loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased">

    <!-- Loading Container -->
    <div id="loading-container" class="min-h-screen flex items-center justify-center hidden">
        <div id="loading-spinner"></div>
    </div>
    
    <!-- Auth Container -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <div id="login-view">
                <h2 class="text-2xl font-bold text-center text-white mb-2">Iniciar Sesión</h2>
                <form id="login-form" class="space-y-4 mt-6">
                    <div>
                        <label for="login-username" class="block text-sm font-medium text-gray-300">Nombre de Usuario</label>
                        <input type="text" id="login-username" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md p-3 text-white" required>
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-300">Contraseña</label>
                        <input type="password" id="login-password" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md p-3 text-white" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg">Entrar</button>
                </form>
                <p class="text-center text-sm text-gray-400 mt-6">¿No tienes cuenta? <button id="show-register-btn" class="font-semibold text-indigo-400 hover:underline">Regístrate</button></p>
            </div>
            <div id="register-view" class="hidden">
                 <h2 class="text-2xl font-bold text-center text-white mb-2">Crear Cuenta</h2>
                <form id="register-form" class="space-y-4 mt-6">
                     <div>
                        <label for="register-username" class="block text-sm font-medium text-gray-300">Nombre de Usuario</label>
                        <input type="text" id="register-username" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md p-3 text-white" required>
                    </div>
                    <div>
                        <label for="register-password" class="block text-sm font-medium text-gray-300">Contraseña</label>
                        <input type="password" id="register-password" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md p-3 text-white" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg">Registrarse</button>
                </form>
                <p class="text-center text-sm text-gray-400 mt-6">¿Ya tienes cuenta? <button id="show-login-btn" class="font-semibold text-indigo-400 hover:underline">Inicia Sesión</button></p>
            </div>
            <p id="auth-error" class="text-red-400 text-center text-sm mt-4"></p>
        </div>
    </div>
    
    <!-- Goal Creation Modal -->
    <div id="goal-modal" class="fixed inset-0 bg-gray-900 bg-opacity-95 z-50 flex items-center justify-center hidden p-4">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <h2 id="goal-modal-title" class="text-2xl font-bold text-center text-white mb-6">Crea tu Objetivo</h2>
            <form id="goal-form" class="space-y-4">
                <div>
                    <label for="initial-bankroll-setup" class="block text-sm font-medium text-gray-300">Banca Inicial (€)</label>
                    <input type="number" step="0.01" min="0.01" id="initial-bankroll-setup" value="50" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md p-3 text-white" required>
                </div>
                <div>
                    <label for="goal-bankroll-setup" class="block text-sm font-medium text-gray-300">Objetivo Final (€)</label>
                    <input type="number" step="0.01" min="1" id="goal-bankroll-setup" value="200000" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md p-3 text-white" required>
                </div>
                <div class="pt-4">
                     <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg">Guardar y Empezar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Kelly Info Modal -->
    <div id="kelly-info-modal" class="fixed inset-0 bg-gray-900 bg-opacity-95 z-50 flex items-center justify-center hidden p-4">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md relative">
            <h3 class="text-xl font-bold text-center text-white mb-4">¿Qué es el Criterio de Kelly?</h3>
            <p class="text-gray-400 text-sm text-center mb-6">El Criterio de Kelly es una fórmula que calcula el **porcentaje óptimo de tu banca** a apostar para maximizar el crecimiento. Se basa en la **ventaja que crees tener** ("Tu Probabilidad %") frente a la cuota. Una sugerencia positiva indica una apuesta con "valor".</p>
            <button id="close-kelly-info" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Entendido</button>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="main-app" class="container mx-auto p-4 md:p-8 max-w-7xl hidden">
        <header class="text-center mb-8 flex justify-between items-center">
             <h1 id="main-app-title" class="text-3xl md:text-4xl font-bold text-white">Betting Syndicate</h1>
             <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">Cerrar Sesión</button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 flex flex-col gap-8">
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4 text-white">Dashboard</h2>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between items-center text-sm mb-1"><span class="text-gray-400">Progreso</span><span id="progress-percentage" class="font-semibold text-white">0.00%</span></div>
                            <div class="w-full bg-gray-700 rounded-full h-4"><div id="progress-bar" class="bg-indigo-500 h-4 rounded-full progress-bar-fill" style="width: 0%"></div></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div><p class="text-gray-400 text-sm">Banca Actual</p><p id="current-bankroll" class="text-2xl font-semibold text-green-400">0,00 €</p></div>
                            <div><p class="text-gray-400 text-sm">Objetivo Final</p><p id="goal-bankroll" class="text-2xl font-semibold text-indigo-400">0,00 €</p></div>
                        </div>
                        <div class="border-t border-gray-700 pt-4 grid grid-cols-2 gap-4 text-sm">
                            <div><p class="text-gray-400">Total Apuestas</p><p id="stats-total-bets" class="font-semibold text-lg">0</p></div>
                            <div><p class="text-gray-400">Tasa de Acierto</p><p id="stats-win-rate" class="font-semibold text-lg">N/A</p></div>
                            <div><p class="text-gray-400">Beneficio Neto</p><p id="stats-net-profit" class="font-semibold text-lg">0,00 €</p></div>
                            <div><p class="text-gray-400">Banca Inicial</p><p id="initial-bankroll" class="font-semibold text-lg">0,00 €</p></div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4 text-white">Registrar Apuesta</h2>
                    <form id="bet-form" class="space-y-4">
                        <div><label for="bet-date" class="block text-sm font-medium text-gray-300">Fecha</label><input type="date" id="bet-date" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md" required></div>
                        <div class="space-y-3" id="selections-container"><label class="block text-sm font-medium text-gray-300">Selecciones</label></div>
                        <button type="button" id="add-selection-btn" class="w-full text-sm bg-gray-700 hover:bg-gray-600 text-indigo-300 font-semibold py-2 px-4 rounded-lg">Añadir Selección</button>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label for="total-odds" class="block text-sm font-medium text-gray-300">Cuota Total</label><input type="number" step="0.001" id="total-odds" class="mt-1 block w-full text-lg font-bold text-indigo-400 bg-gray-900 p-2 rounded-lg text-center" value="1.00"></div>
                            <div><label for="probability" class="block text-sm font-medium text-gray-300">Tu Prob. (%)</label><input type="number" step="1" min="1" max="99" id="probability" placeholder="55" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md"></div>
                        </div>
                        <div class="bg-gray-900 p-3 rounded-lg text-center">
                            <div class="flex justify-center items-center gap-2"><p class="text-sm text-gray-400">Sugerencia Kelly</p><button type="button" id="kelly-info-btn" class="text-indigo-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg></button></div>
                            <p id="kelly-suggestion" class="text-lg font-bold text-indigo-400">N/A</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label for="stake" class="block text-sm font-medium text-gray-300">Apostado</label><input type="number" step="0.01" min="0.01" id="stake" placeholder="10.00" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md" required></div>
                            <div><label for="result" class="block text-sm font-medium text-gray-300">Resultado</label><select id="result" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md"><option value="pending">Pendiente</option><option value="won">Ganada</option><option value="lost">Perdida</option><option value="void">Anulada</option><option value="closed">Cerrada</option></select></div>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg">Añadir Registro</button>
                    </form>
                </div>
            </div>
            <div class="lg:col-span-2 bg-gray-800 rounded-2xl shadow-lg flex flex-col">
                <div class="p-4 border-b border-gray-700"><div class="flex bg-gray-900 rounded-lg p-1"><button id="tab-historial" class="tab-button flex-1 py-2 px-4 rounded-md text-sm font-semibold active">Historial</button><button id="tab-analisis" class="tab-button flex-1 py-2 px-4 rounded-md text-sm font-semibold text-gray-400">Análisis</button></div></div>
                <div id="historial-panel" class="tab-panel flex-grow p-6 overflow-y-auto">
                    <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-white">Historial</h2><button id="clear-data" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">Reiniciar Objetivo</button></div>
                    <table class="w-full text-sm text-left text-gray-300"><thead class="text-xs text-gray-400 uppercase bg-gray-700 sticky top-0"><tr><th class="px-4 py-3">#</th><th class="px-4 py-3">Fecha</th><th class="px-4 py-3">Selecciones</th><th class="px-4 py-3 text-center">Cuota</th><th class="px-4 py-3 text-right">Apostado</th><th class="px-4 py-3 text-center">Resultado</th><th class="px-4 py-3 text-right">Beneficio</th><th class="px-4 py-3 text-right">Saldo Final</th></tr></thead><tbody id="history-body"></tbody></table>
                    <div id="no-bets-message" class="text-center py-16 text-gray-500"><p>Aún no has registrado ninguna apuesta.</p></div>
                </div>
                <div id="analisis-panel" class="tab-panel flex-grow p-6 overflow-y-auto hidden">
                    <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-white">Análisis</h2><div class="flex items-center gap-4"><select id="analisis-filter" class="bg-gray-700 border-gray-600 rounded-md text-sm font-semibold"><option value="all">Siempre</option><option value="7d">Últimos 7 días</option><option value="30d">Últimos 30 días</option><option value="this-month">Este Mes</option><option value="last-month">Mes Pasado</option></select><button id="export-csv" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">Exportar CSV</button></div></div>
                    <div id="no-analysis-data" class="text-center py-16 text-gray-500 hidden"><p>No hay datos suficientes para mostrar el análisis.</p></div>
                    <div id="analysis-content" class="space-y-8">
                        <div><h3 class="text-lg font-semibold mb-3">Rendimiento Mensual</h3><div class="bg-gray-900 p-4 rounded-lg"><canvas id="monthly-chart"></canvas></div></div>
                        <div><h3 class="text-lg font-semibold mb-3">Análisis por Deporte</h3><table class="w-full text-sm text-left"><thead class="text-xs text-gray-400 uppercase bg-gray-700"><tr><th class="px-4 py-2">Deporte</th><th class="px-4 py-2 text-center">Apuestas</th><th class="px-4 py-2 text-center">Acierto %</th><th class="px-4 py-2 text-right">Beneficio</th></tr></thead><tbody id="sport-analysis-body"></tbody></table></div>
                        <div><h3 class="text-lg font-semibold mb-3">Análisis por Competición</h3><table class="w-full text-sm text-left"><thead class="text-xs text-gray-400 uppercase bg-gray-700"><tr><th class="px-4 py-2">Competición</th><th class="px-4 py-2 text-center">Apuestas</th><th class="px-4 py-2 text-center">Acierto %</th><th class="px-4 py-2 text-right">Beneficio</th></tr></thead><tbody id="competition-analysis-body"></tbody></table></div>
                        <div><h3 class="text-lg font-semibold mb-3">Análisis por Rango de Cuotas</h3><table class="w-full text-sm text-left"><thead class="text-xs text-gray-400 uppercase bg-gamma-700"><tr><th class="px-4 py-2">Rango Cuota</th><th class="px-4 py-2 text-center">Apuestas</th><th class="px-4 py-2 text-center">Acierto %</th><th class="px-4 py-2 text-right">Beneficio</th></tr></thead><tbody id="odds-analysis-body"></tbody></table></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, query, updateDoc, writeBatch, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAPI04Ol-sR6W7euNmS1GQAHMBgZ8QqJ6o",
            authDomain: "betting-syndicate-app.firebaseapp.com",
            projectId: "betting-syndicate-app",
            storageBucket: "betting-syndicate-app.appspot.com",
            messagingSenderId: "21634910263",
            appId: "1:21634910263:web:ad7ce1e6adf35fd15f97b2"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global state and config
        const FAKE_EMAIL_DOMAIN = '@betting-syndicate.app';
        let state = { user: null, settings: null, bets: [], betsUnsubscribe: null };
        let monthlyChartInstance = null;
        
        const dom = {
            loadingContainer: document.getElementById('loading-container'),
            authContainer: document.getElementById('auth-container'),
            loginView: document.getElementById('login-view'),
            registerView: document.getElementById('register-view'),
            loginForm: document.getElementById('login-form'),
            registerForm: document.getElementById('register-form'),
            showRegisterBtn: document.getElementById('show-register-btn'),
            showLoginBtn: document.getElementById('show-login-btn'),
            authError: document.getElementById('auth-error'),
            goalModal: document.getElementById('goal-modal'),
            goalForm: document.getElementById('goal-form'),
            mainApp: document.getElementById('main-app'),
            logoutBtn: document.getElementById('logout-btn'),
            betForm: document.getElementById('bet-form'),
            selectionsContainer: document.getElementById('selections-container'),
            addSelectionBtn: document.getElementById('add-selection-btn'),
            totalOddsEl: document.getElementById('total-odds'),
            probabilityInput: document.getElementById('probability'),
            kellySuggestionEl: document.getElementById('kelly-suggestion'),
            kellyInfoBtn: document.getElementById('kelly-info-btn'),
            kellyInfoModal: document.getElementById('kelly-info-modal'),
            closeKellyInfoBtn: document.getElementById('close-kelly-info'),
            historyBody: document.getElementById('history-body'),
            clearDataBtn: document.getElementById('clear-data'),
            exportCsvBtn: document.getElementById('export-csv'),
            currentBankrollEl: document.getElementById('current-bankroll'),
            goalBankrollEl: document.getElementById('goal-bankroll'),
            initialBankrollEl: document.getElementById('initial-bankroll'),
            progressBar: document.getElementById('progress-bar'),
            progressPercentageEl: document.getElementById('progress-percentage'),
            statsTotalBetsEl: document.getElementById('stats-total-bets'),
            statsWinRateEl: document.getElementById('stats-win-rate'),
            statsNetProfitEl: document.getElementById('stats-net-profit'),
            noBetsMessage: document.getElementById('no-bets-message'),
            betDateInput: document.getElementById('bet-date'),
            tabHistorial: document.getElementById('tab-historial'),
            tabAnalisis: document.getElementById('tab-analisis'),
            historialPanel: document.getElementById('historial-panel'),
            analisisPanel: document.getElementById('analisis-panel'),
            analisisFilter: document.getElementById('analisis-filter'),
            noAnalysisData: document.getElementById('no-analysis-data'),
            analysisContent: document.getElementById('analysis-content'),
            sportAnalysisBody: document.getElementById('sport-analysis-body'),
            competitionAnalysisBody: document.getElementById('competition-analysis-body'),
            oddsAnalysisBody: document.getElementById('odds-analysis-body'),
        };

        const formatCurrency = (value) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(value);
        
        // AUTH & Navigation
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                state.user = user;
                showView('loadingContainer');
                if (state.betsUnsubscribe) state.betsUnsubscribe();
                await loadUserSettings();
            } else {
                state.user = null;
                if (state.betsUnsubscribe) state.betsUnsubscribe();
                state.settings = null;
                showView('authContainer');
            }
        });

        function showView(viewName) {
            ['authContainer', 'mainApp', 'goalModal', 'loadingContainer'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            const activeView = document.getElementById(viewName);
            if(activeView) {
                activeView.classList.remove('hidden');
                // SOLUCIÓN: Asegurarse de que los contenedores que usan flexbox lo tengan aplicado
                if(['loadingContainer', 'authContainer', 'goalModal'].includes(viewName)) {
                    activeView.classList.add('flex');
                }
            }
        }
        
        async function loadUserSettings() {
            if (!state.user) return;
            const settingsRef = doc(db, "users", state.user.uid);
            try {
                const settingsSnap = await getDoc(settingsRef);
                if (settingsSnap.exists() && settingsSnap.data().initialBankroll !== undefined) {
                    state.settings = settingsSnap.data();
                    listenForBets();
                    showView('mainApp');
                } else {
                    showView('goalModal');
                }
            } catch (error) {
                console.error("Error loading user settings:", error);
                alert("Error al cargar tu configuración. Revisa las reglas de Firestore.");
                signOut(auth);
            }
        }
        
        function listenForBets() {
             if (state.betsUnsubscribe) state.betsUnsubscribe();
             const betsQuery = query(collection(db, "users", state.user.uid, "bets"), orderBy("date", "desc"));
             state.betsUnsubscribe = onSnapshot(betsQuery, (snapshot) => {
                state.bets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                recalculateBankroll();
             }, (error) => {
                console.error("Error listening for bets:", error);
             });
        }
        
        function recalculateBankroll() {
            if (!state.settings) return;
            let currentBankroll = state.settings.initialBankroll;
            [...state.bets].reverse().forEach(bet => {
                let profit = 0;
                switch(bet.result) {
                    case 'won': profit = bet.stake * (bet.totalOdds - 1); break;
                    case 'lost': profit = -bet.stake; break;
                    case 'pending': profit = -bet.stake; break;
                    case 'void': profit = 0; break;
                    case 'closed': profit = bet.profit; break;
                }
                bet.calculatedProfit = profit;
                bet.finalBankroll = currentBankroll + (bet.result === 'pending' ? -bet.stake : profit);
                currentBankroll = bet.finalBankroll;
            });
            state.bankroll = currentBankroll;
            renderAll();
        }

        function renderAll() {
            if (!state.user || !state.settings) return;
            renderDashboardAndHistory();
            renderAnalysis();
        }
        
        function renderDashboardAndHistory() {
            if (!state.settings) return;

            dom.currentBankrollEl.textContent = formatCurrency(state.bankroll);
            dom.goalBankrollEl.textContent = formatCurrency(state.settings.goalBankroll);
            dom.initialBankrollEl.textContent = formatCurrency(state.settings.initialBankroll);
            const progress = state.settings.goalBankroll > 0 ? Math.max(0, (state.bankroll / state.settings.goalBankroll) * 100) : 0;
            dom.progressBar.style.width = `${progress}%`;
            dom.progressPercentageEl.textContent = `${progress.toFixed(4)}%`;

            const totalBets = state.bets.length;
            dom.statsTotalBetsEl.textContent = totalBets;
            const settledBets = state.bets.filter(b => ['won', 'lost'].includes(b.result));
            const wins = settledBets.filter(b => b.result === 'won').length;
            dom.statsWinRateEl.textContent = settledBets.length > 0 ? `${(wins / settledBets.length * 100).toFixed(2)}%` : 'N/A';
            const netProfit = state.bankroll - state.settings.initialBankroll;
            dom.statsNetProfitEl.textContent = formatCurrency(netProfit);
            dom.statsNetProfitEl.className = `font-semibold text-lg ${netProfit >= 0 ? 'text-green-400' : 'text-red-400'}`;
            dom.historyBody.innerHTML = '';
            dom.noBetsMessage.classList.toggle('hidden', totalBets > 0);

            state.bets.forEach((bet, index) => {
                const row = document.createElement('tr');
                row.className = 'bg-gray-800 border-b border-gray-700 hover:bg-gray-600/50';
                const selectionsHtml = (bet.selections || []).map((s, s_index) => {
                    let resultIndicator;
                    if(bet.result === 'pending') {
                        resultIndicator = `<select data-bet-id="${bet.id}" data-selection-index="${s_index}" class="selection-result-selector text-yellow-400"><option value="pending" ${s.result === 'pending' ? 'selected' : ''}>P</option><option value="won" ${s.result === 'won' ? 'selected' : ''}>G</option><option value="lost" ${s.result === 'lost' ? 'selected' : ''}>L</option></select>`;
                    } else {
                        const resultClasses = { won: 'text-green-400', lost: 'text-red-400', pending: 'text-yellow-400' };
                        const resultTexts = { won: '✓', lost: '✗', pending: '?' };
                        resultIndicator = `<span class="font-bold text-sm ${resultClasses[s.result] || 'text-gray-400'}">${resultTexts[s.result] || '?'}</span>`;
                    }
                    return `<div class="p-1">
                                <div class="flex justify-between items-center">- ${s.description} <span class='text-gray-400 ml-2'>@${s.odds.toFixed(2)}</span> ${resultIndicator}</div>
                                <div class="text-xs text-gray-500 pl-2">${s.sport} - ${s.competition}</div>
                            </div>`;
                }).join('');

                let resultDisplay;
                if (bet.result === 'pending') {
                    resultDisplay = `<select data-bet-id="${bet.id}" class="result-selector text-yellow-400"><option value="pending" selected>Pendiente</option><option value="won">Ganada</option><option value="lost">Perdida</option><option value="void">Anulada</option><option value="closed">Cerrada</option></select>`;
                } else {
                    const resultClasses = { won: 'text-green-400', lost: 'text-red-400', void: 'text-gray-400', closed: 'text-blue-400' };
                    const resultTexts = { won: 'Ganada', lost: 'Perdida', void: 'Anulada', closed: 'Cerrada' };
                    resultDisplay = `<span class="font-bold ${resultClasses[bet.result]}">${resultTexts[bet.result]}</span>`;
                }
                
                let profitDisplay;
                if (bet.result === 'closed') {
                     profitDisplay = `<input type="number" step="any" class="manual-profit-input text-blue-400" data-bet-id="${bet.id}" value="${bet.profit}">`;
                } else {
                    const profit = bet.calculatedProfit;
                    const profitClass = profit > 0 ? 'text-green-400' : profit < 0 ? 'text-red-400' : 'text-gray-400';
                    profitDisplay = `<span class="font-semibold ${profitClass}">${profit >= 0 && bet.result !== 'pending' ? '+' : ''}${formatCurrency(bet.result === 'pending' ? 0 : profit)}</span>`;
                }

                row.innerHTML = `<td class="px-4 py-3 font-medium text-gray-400">${totalBets - index}</td><td class="px-4 py-3 font-semibold text-white">${bet.date ? new Date(bet.date + 'T00:00:00').toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }) : ''}</td><td class="px-4 py-3 text-white text-xs space-y-1">${selectionsHtml}</td><td class="px-4 py-3 text-center font-bold text-indigo-300">${bet.totalOdds.toFixed(3)}</td><td class="px-4 py-3 text-right">${formatCurrency(bet.stake)}</td><td class="px-4 py-3 text-center">${resultDisplay}</td><td class="px-4 py-3 text-right">${profitDisplay}</td><td class="px-4 py-3 text-right font-bold text-white">${formatCurrency(bet.finalBankroll)}</td>`;
                dom.historyBody.appendChild(row);
            });
        }
        
        function renderAnalysis() {
            if (!state.settings) return;
            const settledBets = state.bets.filter(b => b.result !== 'pending' && b.result !== 'void');
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const filterValue = dom.analisisFilter.value;
            
            let filteredBets = settledBets.filter(bet => {
                const betDate = new Date(bet.date);
                if (filterValue === 'all') return true;
                if (filterValue === '7d') return (today - betDate) / (1000 * 60 * 60 * 24) <= 7;
                if (filterValue === '30d') return (today - betDate) / (1000 * 60 * 60 * 24) <= 30;
                if (filterValue === 'this-month') return betDate.getMonth() === now.getMonth() && betDate.getFullYear() === now.getFullYear();
                if (filterValue === 'last-month') {
                    const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    return betDate.getMonth() === lastMonth.getMonth() && betDate.getFullYear() === lastMonth.getFullYear();
                }
                return false;
            });
            
            dom.noAnalysisData.classList.toggle('hidden', filteredBets.length > 0);
            dom.analysisContent.classList.toggle('hidden', filteredBets.length === 0);
            if (filteredBets.length === 0) {
                 if (monthlyChartInstance) monthlyChartInstance.destroy();
                return;
            }

            const monthlyData = filteredBets.reduce((acc, bet) => {
                const month = bet.date.substring(0, 7);
                acc[month] = (acc[month] || 0) + bet.calculatedProfit;
                return acc;
            }, {});
            const sortedMonths = Object.keys(monthlyData).sort();
            if (monthlyChartInstance) monthlyChartInstance.destroy();
            monthlyChartInstance = new Chart(document.getElementById('monthly-chart'), { type: 'bar', data: { labels: sortedMonths, datasets: [{ label: 'Beneficio Neto', data: sortedMonths.map(m => monthlyData[m]), backgroundColor: sortedMonths.map(m => monthlyData[m] >= 0 ? 'rgba(74, 222, 128, 0.5)' : 'rgba(248, 113, 113, 0.5)'), borderColor: sortedMonths.map(m => monthlyData[m] >= 0 ? 'rgb(74, 222, 128)' : 'rgb(248, 113, 113)'), borderWidth: 1 }] }, options: { scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } } });

            const renderGroupAnalysis = (groupBy, bodyElement) => {
                 const groupData = filteredBets.flatMap(bet => 
                    (bet.selections || []).map(selection => ({
                        key: selection[groupBy],
                        result: bet.result,
                        profit: bet.calculatedProfit / (bet.selections.length || 1)
                    }))
                ).reduce((acc, item) => {
                    const key = item.key;
                    if (!key) return acc;
                    if (!acc[key]) acc[key] = { total: 0, wins: 0, profit: 0 };
                    acc[key].total++;
                    if (item.result === 'won' || (item.result === 'closed' && item.profit > 0)) acc[key].wins++;
                    acc[key].profit += item.profit;
                    return acc;
                }, {});

                bodyElement.innerHTML = '';
                Object.entries(groupData).sort((a,b) => b[1].total - a[1].total).forEach(([key, data]) => {
                    const row = document.createElement('tr');
                    const winRate = data.total > 0 ? ((data.wins / data.total) * 100).toFixed(1) + '%' : '0.0%';
                    const profitClass = data.profit > 0 ? 'text-green-400' : data.profit < 0 ? 'text-red-400' : 'text-gray-400';
                    row.innerHTML = `<td class="px-4 py-2 font-semibold">${key}</td><td class="px-4 py-2 text-center">${data.total}</td><td class="px-4 py-2 text-center">${winRate}</td><td class="px-4 py-2 text-right font-semibold ${profitClass}">${formatCurrency(data.profit)}</td>`;
                    bodyElement.appendChild(row);
                });
            };
            
            renderGroupAnalysis('sport', dom.sportAnalysisBody);
            renderGroupAnalysis('competition', dom.competitionAnalysisBody);
        };
        
        const handleFormSubmit = async (e) => {
            e.preventDefault();
            const stake = parseFloat(document.getElementById('stake').value);
            if (stake > state.bankroll) return alert("La cantidad apostada no puede ser mayor que tu banca actual.");

            const selections = Array.from(dom.selectionsContainer.querySelectorAll('.selection-row')).map(row => ({
                description: row.querySelector('.selection-desc').value,
                odds: parseFloat(row.querySelector('.selection-odds').value),
                sport: row.querySelector('.selection-sport').value,
                competition: row.querySelector('.selection-competition').value,
                result: 'pending'
            })).filter(s => s.description && !isNaN(s.odds) && s.sport && s.competition);
            if (selections.length === 0) return alert("Añade al menos una selección válida con todos sus campos.");
            
            const newBet = {
                date: dom.betDateInput.value, 
                selections, totalOdds: parseFloat(dom.totalOddsEl.value), stake,
                result: document.getElementById('result').value, profit: 0, 
            };
            
            await addDoc(collection(db, "users", state.user.uid, "bets"), newBet);
            
            dom.betForm.reset();
            dom.selectionsContainer.innerHTML = '<label class="block text-sm font-medium text-gray-300">Selecciones</label>';
            addSelectionHTML();
            calculateTotalOdds();
            dom.betDateInput.valueAsDate = new Date();
        };
        
        const addSelectionHTML = () => {
            const selectionCount = dom.selectionsContainer.querySelectorAll('.selection-row').length;
            const newSelection = document.createElement('div');
            newSelection.className = 'selection-row space-y-2';
            newSelection.innerHTML = `
                <div class="grid grid-cols-10 gap-2 items-center">
                    <input type="text" placeholder="Descripción de la Selección ${selectionCount + 1}" class="selection-desc col-span-7 bg-gray-900 border-gray-600 rounded-md text-white text-sm p-2" required>
                    <input type="number" step="0.01" min="1.01" placeholder="Cuota" class="selection-odds col-span-2 bg-gray-900 border-gray-600 rounded-md text-white text-sm p-2" required>
                    <button type="button" class="remove-selection-btn col-span-1 text-red-400 hover:text-red-600 text-2xl font-bold">&times;</button>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" placeholder="Deporte" class="selection-sport bg-gray-900 border-gray-600 rounded-md text-white text-xs p-2" required>
                    <input type="text" placeholder="Competición" class="selection-competition bg-gray-900 border-gray-600 rounded-md text-white text-xs p-2" required>
                </div>
            `;
            dom.selectionsContainer.appendChild(newSelection);
            newSelection.querySelector('.selection-odds').addEventListener('input', calculateTotalOdds);
            newSelection.querySelector('.remove-selection-btn').addEventListener('click', () => {
                newSelection.remove();
                calculateTotalOdds();
            });
        };

        const calculateTotalOdds = () => {
            const oddsInputs = dom.selectionsContainer.querySelectorAll('.selection-odds');
            let totalOdds = 1;
            oddsInputs.forEach(input => {
                const odd = parseFloat(input.value);
                if (!isNaN(odd) && odd > 0) totalOdds *= odd;
            });
            dom.totalOddsEl.value = totalOdds.toFixed(3);
            calculateKelly();
        };

        const calculateKelly = () => {
            if (!state.settings) return;
            const odds = parseFloat(dom.totalOddsEl.value);
            const prob = parseFloat(dom.probabilityInput.value) / 100;
            if (isNaN(odds) || isNaN(prob) || odds <= 1 || prob <= 0 || prob >= 1) {
                dom.kellySuggestionEl.textContent = 'N/A';
                return;
            }
            const kellyFraction = ((odds - 1) * prob - (1 - prob)) / (odds - 1);
            if (kellyFraction <= 0) {
                dom.kellySuggestionEl.textContent = `No apostar`;
                return;
            }
            const suggestedStake = state.bankroll * kellyFraction;
            dom.kellySuggestionEl.textContent = `${formatCurrency(suggestedStake)} (${(kellyFraction * 100).toFixed(2)}%)`;
        };

        const handleExportCSV = () => {
            if(state.bets.length === 0) return alert("No hay datos para exportar.");
            let csvContent = "data:text/csv;charset=utf-8,";
            const headers = ["#", "Fecha", "Deporte", "Competición", "Selección", "Cuota Selección", "Resultado Selección", "Cuota Total Apuesta", "Apostado", "Resultado Apuesta", "Beneficio", "Saldo Final"];
            csvContent += headers.join(",") + "\r\n";
            const betsToExport = [...state.bets].reverse();
            let betCounter = 0;
            betsToExport.forEach(bet => {
                betCounter++;
                (bet.selections || []).forEach(sel => {
                    const row = [
                        betCounter, bet.date, sel.sport, sel.competition, `"${sel.description}"`, sel.odds, sel.result,
                        bet.totalOdds.toFixed(3), bet.stake, bet.result, bet.calculatedProfit, bet.finalBankroll
                    ];
                    csvContent += row.join(",") + "\r\n";
                });
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `historial_apuestas.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        
        // EVENT LISTENERS
        dom.showRegisterBtn.addEventListener('click', () => { dom.loginView.classList.add('hidden'); dom.registerView.classList.remove('hidden'); dom.authError.textContent = ''; });
        dom.showLoginBtn.addEventListener('click', () => { dom.registerView.classList.add('hidden'); dom.loginView.classList.remove('hidden'); dom.authError.textContent = ''; });

        dom.registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            dom.authError.textContent = '';
            const username = dom.registerForm['register-username'].value.trim().toLowerCase();
            const password = dom.registerForm['register-password'].value;
            if(!username) { dom.authError.textContent = "El nombre de usuario no puede estar vacío."; return; }
            const email = username + FAKE_EMAIL_DOMAIN;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') dom.authError.textContent = "Ese nombre de usuario ya existe.";
                else if (error.code === 'auth/weak-password') dom.authError.textContent = "La contraseña debe tener al menos 6 caracteres.";
                else dom.authError.textContent = "Ha ocurrido un error al registrar la cuenta.";
            }
        });

        dom.loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            dom.authError.textContent = '';
            const username = dom.loginForm['login-username'].value.trim().toLowerCase();
            const password = dom.loginForm['login-password'].value;
            const email = username + FAKE_EMAIL_DOMAIN;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                dom.authError.textContent = "Usuario o contraseña incorrectos.";
            }
        });

        dom.logoutBtn.addEventListener('click', () => signOut(auth));
        
        dom.goalForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const initial = parseFloat(document.getElementById('initial-bankroll-setup').value);
            const goal = parseFloat(document.getElementById('goal-bankroll-setup').value);
            if (initial >= 0 && goal > initial) {
                const settings = { initialBankroll: initial, goalBankroll: goal };
                await setDoc(doc(db, "users", state.user.uid), settings);
                state.settings = settings;
                listenForBets();
                showView('mainApp');
            } else {
                alert("Por favor, rellena todos los campos con valores válidos.");
            }
        });

        dom.betForm.addEventListener('submit', handleFormSubmit);
        
        dom.historyBody.addEventListener('change', async (e) => {
            const betId = e.target.dataset.betId;
            if (!betId || !state.settings) return;
            const betRef = doc(db, "users", state.user.uid, "bets", betId);

            if (e.target.classList.contains('result-selector')) {
                const newResult = e.target.value;
                const updateData = { result: newResult };
                if (newResult === 'closed') updateData.profit = 0;
                await updateDoc(betRef, updateData);
            }
            if (e.target.classList.contains('selection-result-selector')) {
                const selectionIndex = parseInt(e.target.dataset.selectionIndex, 10);
                const bet = state.bets.find(b => b.id === betId);
                const newSelections = [...(bet.selections || [])];
                newSelections[selectionIndex].result = e.target.value;
                
                let newBetResult = bet.result;
                if(newSelections.some(s => s.result === 'lost')) newBetResult = 'lost';
                else if (newSelections.every(s => s.result === 'won')) newBetResult = 'won';
                
                await updateDoc(betRef, { selections: newSelections, result: newBetResult });
            }
        });
        
        dom.historyBody.addEventListener('input', async (e) => {
             if (e.target.classList.contains('manual-profit-input')) {
                const betId = e.target.dataset.betId;
                const newProfit = parseFloat(e.target.value);
                if (!isNaN(newProfit) && state.settings) {
                    await updateDoc(doc(db, "users", state.user.uid, "bets", betId), { profit: newProfit });
                }
            }
        });
        
        dom.clearDataBtn.addEventListener('click', async () => { 
            if (confirm("¿Seguro que quieres borrar TODAS tus apuestas y reiniciar tu objetivo? Esta acción es irreversible.")) {
                const batch = writeBatch(db);
                state.bets.forEach(bet => {
                    const betRef = doc(db, "users", state.user.uid, "bets", bet.id);
                    batch.delete(betRef);
                });
                await batch.commit();
                
                const settingsRef = doc(db, "users", state.user.uid);
                await setDoc(settingsRef, {});
                showView('goalModal');
            }
        });
        
        dom.exportCsvBtn.addEventListener('click', handleExportCSV);

        addSelectionHTML();
        dom.betDateInput.valueAsDate = new Date();
        dom.addSelectionBtn.addEventListener('click', addSelectionHTML);
        dom.probabilityInput.addEventListener('input', calculateKelly);
        dom.totalOddsEl.addEventListener('input', calculateKelly);
        dom.selectionsContainer.addEventListener('input', (e) => { if(e.target.classList.contains('selection-odds')) calculateTotalOdds(); });
        dom.analisisFilter.addEventListener('change', renderAnalysis);
        dom.tabHistorial.addEventListener('click', () => { dom.tabHistorial.classList.add('active'); dom.tabAnalisis.classList.remove('active'); dom.historialPanel.classList.remove('hidden'); dom.analisisPanel.classList.add('hidden'); });
        dom.tabAnalisis.addEventListener('click', () => { dom.tabAnalisis.classList.add('active'); dom.tabHistorial.classList.remove('active'); dom.analisisPanel.classList.remove('hidden'); dom.historialPanel.classList.add('hidden'); renderAnalysis(); });
        dom.kellyInfoBtn.addEventListener('click', () => dom.kellyInfoModal.classList.remove('hidden'));
        dom.closeKellyInfoBtn.addEventListener('click', () => dom.kellyInfoModal.classList.add('hidden'));

    </script>
</body>
</html>

